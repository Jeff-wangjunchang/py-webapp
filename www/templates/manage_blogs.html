{% extends '__base__.html' %}

{% block title %}博客{% endblock %}

{% block beforehead %}

<script>
// 与继承页面 methods 合并
methods = $.extend(methods , {
    handleClick(tab, event) {
        window.location.href = tab.$attrs.href;
    },
    create_blog() {
        window.location.href = '/manage/blogs/create';
    },
    edit_blog: function (blog) {
        location.assign('/manage/blogs/edit?id=' + blog.id);
    },
    delete_blog: function (blog) {
        if (confirm('确认要删除“' + blog.name + '”？删除后不可恢复！')) {
            postJSON('/api/blogs/' + blog.id + '/delete', function (err, r) {
                if (err) {
                    return alert(err.message || err.error || err);
                }
                refresh();
            });
        }
    },
    // 分页触发 
    handleSizeChange(val) {
        console.log(`每页 ${val} 条`);
        // 从第一页开始请求 page = 1
        getItemJson(1);
    },
    // 当前页触发
    handleCurrentChange(val) {
        console.log(`当前页: ${val}`);
        // 获取当前页
        getItemJson(val);
    }
})
// 与继承页面 data 合并
data = $.extend(data, {
    blogs: {},
    page: {},
    activeName: '2',
    tableData: [],
    loading: true
})

$(function() {
    getItemJson([[page_index]])
});

function getItemJson(page_index) {
    getJSON('/api/blogs', {
        page: page_index
    }, function (err, results) {
        if (err) {
            return fatal(err);
        }
        appVm.loading = false;
        appVm.blogs = results.blogs;
        log(results)
        appVm.page = results.page;
        appVm.tableData = results.blogs;
        $('#vm').show();
    });
}

</script>

{% endblock %}

{% block content %}

    <el-row>
        <el-col :span="24">
            <el-tabs v-model="activeName" tab-position="top" @tab-click="handleClick">
                <el-tab-pane label="评论" name="1" href="/manage/comments"></el-tab-pane>
                <el-tab-pane label="博客" name="2" href="/manage/blogs">
                    <!-- content start -->
                    <el-card class="box-card">
                        <el-button type="primary" size="small" @click="create-blog">新博客</el-button>
                        <el-table :data="tableData" v-loading="loading" style="width: 100%">
                            <el-table-column prop="name" label="标题 / 摘要">
                                <template slot-scope='scope'>
                                    <el-link type="primary" target='_blank' :href="'/blog/'+scope.row.id">{{ scope.row.name }}</el-link>
                                </template>
                            </el-table-column>
                            <el-table-column prop="user_name" label="作者">
                                <template slot-scope='scope'>
                                    <el-link type="primary" target='_blank' :href="'/user/'+scope.row.user_id">{{ scope.row.user_name }}</el-link>
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="日期">
                                <template slot-scope='scope'>
                                    <span>{{ scope.row.created_at.toDateTime() }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column fixed="right" label="操作">
                                <template slot-scope="scope">
                                    <el-button @click="edit_blog(scope.row)" type="text" size="small">编辑</el-button>
                                    <el-button @click="delete_blog(scope.row)" type="danger" size="mini">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <br>
                        <el-pagination class="center"
                        @size-change="handleSizeChange"
                        @current-change="handleCurrentChange"
                        :current-page="page.page_index"
                        :page-size="page.page_size"
                        :total="page.item_count"
                        :hide-on-single-page="true"
                        :page-sizes="[10, 20, 50, 100, 200, 500]"
                        layout="total, slot, prev, pager, next, jumper"
                        >
                        <template>
                            <span class="el-pagination__total">每页10条</span>
                        </template>
                        </el-pagination>
                    </el-card>
                    <!-- content end -->
                </el-tab-pane>
                <el-tab-pane label="用户" name="3" href="/manage/users"></el-tab-pane>
            </el-tabs>
        </el-col>
    </el-row>

{% endblock %}

